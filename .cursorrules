# Quy táº¯c Code cho Student Management System

## 1. KIáº¾N TRÃšC Dá»° ÃN

### Backend Structure
- `src/backend/database/models/` - Sequelize models
- `src/services/` - Business logic services  
- `src/repositories/` - Data access layer
- `src/controllers/` - API controllers
- `src/routes/` - Express routes
- `src/middleware/` - Custom middleware

### Frontend
- `src/components/` - React components (AdminJS)
- `src/config/` - AdminJS configurations

## 2. NAMING CONVENTIONS

### Database
- **Tables**: PascalCase singular (Grade, Student, User)
- **Primary Key**: `id` (auto-increment INTEGER)
- **Foreign Keys**: `{model}Id` (studentId, subjectId)
- **Columns**: camelCase (gradeStatus, txScore, dkScore)
- **Status fields**: lowercase with underscore (draft, pending_review, approved_tx_dk)

### Files
- **Models**: PascalCase (Grade.js, GradeStateTransition.js)
- **Services**: PascalCase with "Service" suffix (GradeStateService.js)
- **Controllers**: PascalCase with "Controller" suffix (GradeApiController.js)
- **Components**: PascalCase (TeacherGradeEntryComponent.jsx)

### Code
- **Classes**: PascalCase
- **Functions/Methods**: camelCase
- **Constants**: UPPER_SNAKE_CASE
- **Private methods**: prefix with underscore `_methodName`

## 3. DATABASE RULES

### Models pháº£i match vá»›i Database Schema
```javascript
// ÄÃšNG - Check database schema trÆ°á»›c
const Grade = sequelize.define('Grade', {
  id: { type: DataTypes.INTEGER, primaryKey: true }, // NOT gradeId
  gradeStatus: DataTypes.STRING(50) // NOT status
});

// SAI - Tá»± nghÄ© tÃªn column
```

### Foreign Keys
```javascript
// ÄÃšNG
gradeId: {
  references: { model: 'Grades', key: 'id' } // key lÃ  'id', NOT 'gradeId'
}
```

## 4. SERVICE LAYER PATTERNS

### Services pháº£i lÃ  static class
```javascript
class GradeStateService {
  static async submitForReview(gradeId, userId, reason) {
    // Business logic here
  }
}
```

### Error Handling
```javascript
try {
  // Logic
  console.log(`âœ… Success message`);
  return result;
} catch (error) {
  console.error(`âŒ Error message:`, error);
  throw error; // Re-throw Ä‘á»ƒ controller xá»­ lÃ½
}
```

### Logging Format
- âœ… Success: `console.log(\`âœ… Action completed\`)`
- âŒ Error: `console.error(\`âŒ Action failed:\`, error)`
- ğŸ” Debug: `console.log('ğŸ” Variable:', value)`
- ğŸ“¤ API: `console.log('[ADMIN-API] GET /path - User: email')`

## 5. API ROUTES PATTERNS

### Route Structure
```javascript
router.post('/endpoint', async (req, res) => {
  try {
    // 1. Extract params
    const { param1, param2 } = req.body;
    const userId = req.session?.adminUser?.id;
    
    // 2. Validate
    if (!userId) {
      return res.status(401).json({ 
        success: false, 
        message: 'ChÆ°a Ä‘Äƒng nháº­p' 
      });
    }
    
    // 3. Call service
    const result = await Service.method(param1, userId);
    
    // 4. Return success
    res.json({
      success: true,
      message: 'ThÃ nh cÃ´ng',
      data: result
    });
    
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({
      success: false,
      message: error.message || 'Lá»—i server'
    });
  }
});
```

## 6. GRADE STATE WORKFLOW

### States
1. `draft` - Teacher nháº­p TX/ÄK
2. `pending_review` - ÄÃ£ submit, chá» admin duyá»‡t
3. `approved_tx_dk` - Admin Ä‘Ã£ duyá»‡t TX/ÄK
4. `final_entered` - ÄÃ£ nháº­p Ä‘iá»ƒm thi
5. `finalized` - HoÃ n táº¥t, publish cho SV

### Field Locking
- `txLocked` - Lock Ä‘iá»ƒm TX
- `dkLocked` - Lock Ä‘iá»ƒm ÄK  
- `finalLocked` - Lock Ä‘iá»ƒm thi

## 7. REACT COMPONENTS (AdminJS)

### State Management
```javascript
const [gradeStatuses, setGradeStatuses] = useState({});
// Structure: { studentId: { gradeId, gradeStatus, lockStatus, ... } }
```

### Update State After API Call
```javascript
if (result.results && result.results.details) {
  const newStatuses = { ...gradeStatuses };
  result.results.details.forEach(detail => {
    newStatuses[detail.studentId] = {
      gradeId: detail.gradeId,
      gradeStatus: 'draft',
      // ...
    };
  });
  setGradeStatuses(newStatuses);
}
```

## 8. DEBUGGING

### Console Logs Format
```javascript
console.log('ğŸ” Function called with:', { param1, param2 });
console.log('ğŸ“Š Current state:', stateName);
console.log('âœ… Success:', result);
console.error('âŒ Error:', error.message);
```

### Required Logs
- API entry: Request params
- Database queries: WHERE conditions
- State changes: Before/After values
- Errors: Full error message + context

## 9. VALIDATION RULES

### Before Save
- Check required fields not null
- Validate score ranges (0-10)
- Check foreign key exists
- Validate state transitions

### Before Submit
```javascript
// Ãt nháº¥t pháº£i cÃ³ TX hoáº·c ÄK
if (!grade.txScore && !grade.dkScore) {
  throw new Error('Pháº£i nháº­p Ã­t nháº¥t Ä‘iá»ƒm TX hoáº·c ÄK');
}
```

## 10. VERSION CONTROL

### History Tracking
- Save to GradeHistory before each update
- Increment version number
- Log who changed what

```javascript
await GradeHistory.create({
  gradeId: grade.id,
  version: grade.version,
  txScore: grade.txScore,
  // ... all fields
  editedBy: userId,
  changeDescription: 'What changed'
});
```

## 11. TRANSACTION PATTERNS

### Use Transaction for Multi-Step Operations
```javascript
const transaction = await sequelize.transaction();
try {
  // Step 1
  await Model1.create({ ... }, { transaction });
  // Step 2
  await Model2.update({ ... }, { transaction });
  
  await transaction.commit();
} catch (error) {
  await transaction.rollback();
  throw error;
}
```

## 12. COMMON MISTAKES TO AVOID

âŒ **Äá»ªNG LÃ€M**:
- DÃ¹ng `grade.gradeId` â†’ DÃ¹ng `grade.id` (check model first!)
- DÃ¹ng `fromStatus/toStatus` â†’ Check database: `fromState/toState`
- Tá»± nghÄ© tÃªn column â†’ LuÃ´n check `DESCRIBE table_name` trÆ°á»›c
- So sÃ¡nh string case-sensitive â†’ DÃ¹ng `.toLowerCase()`
- Return object trong error message â†’ DÃ¹ng `.label` hoáº·c `.message`
- Táº¡o file documentation â†’ User yÃªu cáº§u: Äá»ªNG táº¡o docs!

âœ… **NÃŠN LÃ€M**:
- Check database schema trÆ°á»›c khi code
- Check primary key name (id vs gradeId vs grade_id)
- Match column names exactly with database
- Handle case-insensitive string comparison
- Re-throw errors tá»« service lÃªn controller
- Add comprehensive logging
- Update React state after API calls

## 13. TESTING CHECKLIST

TrÆ°á»›c khi hoÃ n thÃ nh task:
- [ ] Code cháº¡y khÃ´ng lá»—i syntax
- [ ] Model fields match database columns
- [ ] Foreign keys reference Ä‘Ãºng
- [ ] API response cÃ³ Ä‘á»§ data cáº§n thiáº¿t
- [ ] React state Ä‘Æ°á»£c update sau API call
- [ ] Console logs Ä‘áº§y Ä‘á»§ Ä‘á»ƒ debug
- [ ] Error messages rÃµ rÃ ng (khÃ´ng cÃ³ [object Object])

## 14. USER PREFERENCES

- âŒ **KHÃ”NG** táº¡o file documentation/hÆ°á»›ng dáº«n
- âœ… **CHá»ˆ** fix code trá»±c tiáº¿p
- âœ… Explain ngáº¯n gá»n trong comment hoáº·c chat
- âœ… Add logging Ä‘á»ƒ user tá»± debug
