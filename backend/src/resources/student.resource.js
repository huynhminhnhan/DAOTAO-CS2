/**
 * Student Resource Configuration
 * C·∫•u h√¨nh resource Student v·ªõi layout 2 c·ªôt th·ª±c s·ª±
 * 
 * Note: Teacher permissions are now managed via TeacherPermission model.
 */
import { Student } from '../database/index.js';
import { Components } from '../config/components.js';
import { getTeacherManagedClassIds } from '../middleware/teacherPermissions.js';

const StudentResource = {
  resource: Student,
  options: {
    parent: {
      name: 'Qu·∫£n l√Ω Sinh vi√™n',
      icon: 'User'
    },
    
    // // C·∫•u h√¨nh pagination
    // sort: {
    //   sortBy: 'studentCode',
    //   direction: 'asc'
    // },
    
    // // TƒÉng s·ªë records m·∫∑c ƒë·ªãnh cho list
    // navigation: {
    //   name: 'Students'
    // },
    
    // C·∫•u h√¨nh hi·ªÉn th·ªã list
    listProperties: ['studentCode', 'fullName', 'email', 'gender', 'classId', 'status', 'createdAt'],
    
    // C·∫•u h√¨nh edit/new form
    editProperties: [
      'studentCode', 'fullName', 'email', 'classId',
      'gender', 'dateOfBirth', 'phone', 'status'
    ],
    
    // C·∫•u h√¨nh show (chi ti·∫øt)
    showProperties: [
      'studentCode', 'fullName', 'email', 'classId',
      'gender', 'dateOfBirth', 'phone', 'status',
  'createdAt', 'updatedAt', 'gradeHistoryTab'
    ],
    
    // C·∫•u h√¨nh filter
    filterProperties: ['studentCode', 'fullName', 'email', 'classId', 'status', 'gender'],
    
    // C·∫•u h√¨nh properties
    properties: {
      studentCode: { 
        // isTitle: true, 
        isRequired: true,
        position: 1,
        description: 'M√£ sinh vi√™n duy nh·∫•t'
      },
      fullName: { 
        isRequired: true, 
        isRequired: true,
        position: 2,
        description: 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß c·ªßa sinh vi√™n'
      },
      email: { 
        isRequired: false, 
        type: 'email',
        position: 3,
        description: 'Email li√™n h·ªá'
      },
      classId: { 
        isRequired: true,
        position: 4,
        description: 'L·ªõp h·ªçc c·ªë ƒë·ªãnh su·ªët kh√≥a'
      },
      gender: {
        type: 'select',
        availableValues: [
          { value: 'male', label: 'Nam' },
          { value: 'female', label: 'N·ªØ' },
          { value: 'other', label: 'Kh√°c' }
        ],
        position: 5,
        description: 'Gi·ªõi t√≠nh'
      },
      dateOfBirth: {
  type: 'date',
  position: 6,
  label: 'Ng√†y sinh',
  // description is optional but kept for help text
  description: 'Ng√†y sinh',
        components: {
          show: Components.DateShowDDMMYYYY,
          edit: Components.DatePickerFlatpickr,
          new: Components.DatePickerFlatpickr
        }
      },
      phone: {
        position: 7,
        description: 'S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá'
      },
      status: {
        type: 'select',
        availableValues: [
          { value: 'active', label: '‚úÖ ƒêang h·ªçc' },
          { value: 'suspended', label: '‚è∏Ô∏è T·∫°m ngh·ªâ' },
          { value: 'graduated', label: 'üéì ƒê√£ t·ªët nghi·ªáp' },
          { value: 'dropped', label: '‚ùå Th√¥i h·ªçc' }
        ],
        position: 8,
        description: 'Tr·∫°ng th√°i h·ªçc t·∫≠p hi·ªán t·∫°i'
      },
      createdAt: {
        isVisible: { list: true, filter: false, show: true, edit: false }
      },
      updatedAt: {
        isVisible: { list: false, filter: false, show: true, edit: false }
      }
      ,
      // Virtual property to render grade history tab inside show view
      gradeHistoryTab: {
        isVisible: { list: false, filter: false, show: true, edit: false, new: false },
        components: {
          show: Components.StudentGradeHistoryTab
        }
      }
    },
    
    // Layout 2 c·ªôt cho form edit v√† new
    actions: {
      list: {
        isAccessible: true,
        before: async (request, context) => {
          const { currentAdmin } = context;
          console.log('[StudentResource] List action - User:', currentAdmin?.email, 'Role:', currentAdmin?.role);
          
          // N·∫øu l√† teacher, inject filter v√†o request ƒë·ªÉ AdminJS query ƒë√∫ng t·ª´ ƒë·∫ßu
          if (currentAdmin?.role === 'teacher') {
            const allowedClassIds = await getTeacherManagedClassIds(currentAdmin.id);
            
          
            
            // N·∫øu kh√¥ng c√≥ quy·ªÅn v·ªõi t·∫•t c·∫£ l·ªõp, th√™m filter classId
            if (allowedClassIds !== 'all') {
              const currentFilters = request.query?.filters || {};
              
              if (allowedClassIds.length === 0) {
                // Kh√¥ng c√≥ quy·ªÅn - filter ƒë·ªÉ kh√¥ng tr·∫£ v·ªÅ record n√†o
                request.query = {
                  ...request.query,
                  filters: {
                    ...currentFilters,
                    classId: '-999999' // ID kh√¥ng t·ªìn t·∫°i
                  }
                };
              
              } else {
                // C√≥ quy·ªÅn v·ªõi c√°c l·ªõp c·ª• th·ªÉ - inject filter classId
                // AdminJS h·ªó tr·ª£ filter v·ªõi comma-separated values cho "in" operator
                request.query = {
                  ...request.query,
                  filters: {
                    ...currentFilters,
                    classId: allowedClassIds.join(',') // VD: "12,13,14"
                  }
                };
              
              }
            } else {
              console.log('[StudentResource] Teacher has access to ALL classes');
            }
          }
          
          return request;
        },
        after: async (response, request, context) => {
          const { currentAdmin } = context;
          
          // FALLBACK: N·∫øu before hook filter kh√¥ng work, d√πng after hook
          if (currentAdmin?.role === 'teacher') {
            const allowedClassIds = await getTeacherManagedClassIds(currentAdmin.id);
            
            console.log('[StudentResource] After hook - Filtering records');
            console.log('[StudentResource] Total records before filter:', response.records.length);
            
            if (allowedClassIds === 'all') {
              console.log('[StudentResource] Teacher has access to ALL students');
              return response;
            }
            
            if (allowedClassIds.length === 0) {
              console.log('[StudentResource] Teacher has NO permissions');
              response.records = [];
              response.meta.total = 0;
              return response;
            }
            
            // Filter records theo classId
            const allowedIdsSet = new Set(allowedClassIds);
            const filteredRecords = response.records.filter(record => {
              const classId = parseInt(record.params?.classId);
              const isAllowed = allowedIdsSet.has(classId);
              
              if (!isAllowed) {
                console.log(`[StudentResource] Filtering out student ID ${record.params?.id} (classId: ${classId})`);
              }
              
              return isAllowed;
            });
          
            
            response.records = filteredRecords;
            response.meta.total = filteredRecords.length;
          }
          
          return response;
        }
      },
      show: {
        isAccessible: true, // Cho ph√©p t·∫•t c·∫£ xem chi ti·∫øt
        layout: [
          // H√†ng 1: M√£ SV v√† H·ªç t√™n
          [{ flexDirection: 'row', flex: true }, [
            ['studentCode', { flexGrow: 1, marginRight: 'default' }],
            ['fullName', { flexGrow: 1 }]
          ]],
          // H√†ng 2: Email v√† L·ªõp
          [{ flexDirection: 'row', flex: true }, [
            ['email', { flexGrow: 1, marginRight: 'default' }],
            ['classId', { flexGrow: 1 }]
          ]],
          // H√†ng 3: Gi·ªõi t√≠nh v√† Ng√†y sinh
          [{ flexDirection: 'row', flex: true }, [
            ['gender', { flexGrow: 1, marginRight: 'default' }],
            ['dateOfBirth', { flexGrow: 1 }]
          ]],
          // H√†ng 4: ƒêi·ªán tho·∫°i v√† Tr·∫°ng th√°i
          [{ flexDirection: 'row', flex: true }, [
            ['phone', { flexGrow: 1, marginRight: 'default' }],
            ['status', { flexGrow: 1 }]
          ]]
        ]
      },
      new: {
        isAccessible: ({ currentAdmin }) => currentAdmin?.role === 'admin', // Ch·ªâ admin t·∫°o m·ªõi
        layout: [
          // H√†ng 1: M√£ SV v√† H·ªç t√™n
          [{ flexDirection: 'row', flex: true }, [
            ['studentCode', { flexGrow: 1, marginRight: 'default' }],
            ['fullName', { flexGrow: 1 }]
          ]],
          // H√†ng 2: Email v√† L·ªõp
          [{ flexDirection: 'row', flex: true }, [
            ['email', { flexGrow: 1, marginRight: 'default' }],
            ['classId', { flexGrow: 1 }]
          ]],
          // H√†ng 3: Gi·ªõi t√≠nh v√† Ng√†y sinh
          [{ flexDirection: 'row', flex: true }, [
            ['gender', { flexGrow: 1, marginRight: 'default' }],
            ['dateOfBirth', { flexGrow: 1 }]
          ]],
          // H√†ng 4: ƒêi·ªán tho·∫°i v√† Tr·∫°ng th√°i
          [{ flexDirection: 'row', flex: true }, [
            ['phone', { flexGrow: 1, marginRight: 'default' }],
            ['status', { flexGrow: 1 }]
          ]]
        ]
      },
      edit: {
        isAccessible: ({ currentAdmin }) => currentAdmin?.role === 'admin', // Ch·ªâ admin s·ª≠a
        layout: [
          // H√†ng 1: M√£ SV v√† H·ªç t√™n
          [{ flexDirection: 'row', flex: true }, [
            ['studentCode', { flexGrow: 1, marginRight: 'default' }],
            ['fullName', { flexGrow: 1 }]
          ]],
          // H√†ng 2: Email v√† L·ªõp
          [{ flexDirection: 'row', flex: true }, [
            ['email', { flexGrow: 1, marginRight: 'default' }],
            ['classId', { flexGrow: 1 }]
          ]],
          // H√†ng 3: Gi·ªõi t√≠nh v√† Ng√†y sinh
          [{ flexDirection: 'row', flex: true }, [
            ['gender', { flexGrow: 1, marginRight: 'default' }],
            ['dateOfBirth', { flexGrow: 1 }]
          ]],
          // H√†ng 4: ƒêi·ªán tho·∫°i v√† Tr·∫°ng th√°i
          [{ flexDirection: 'row', flex: true }, [
            ['phone', { flexGrow: 1, marginRight: 'default' }],
            ['status', { flexGrow: 1 }]
          ]]
        ]
      },
      delete: {
        isAccessible: ({ currentAdmin }) => currentAdmin?.role === 'admin' // Ch·ªâ admin x√≥a
      },
      importStudents: {
        actionType: 'resource',
        icon: 'Upload',
        label: 'Import sinh vi√™n t·ª´ Excel',
        component: Components.StudentImportComponent,
        isAccessible: ({ currentAdmin }) => currentAdmin?.role === 'admin', // Ch·ªâ admin import
        handler: async (request, response, context) => {
          // Ch·ªâ hi·ªÉn th·ªã component, logic x·ª≠ l√Ω s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán qua API ri√™ng
          return {
            record: {}
          };
        }
      },
      viewTranscript: {
        actionType: 'record',
        label: 'Xem b·∫£ng ƒëi·ªÉm',
        component: Components.StudentTranscriptComponent,
        showInDrawer: false,
        isAccessible: true, // Cho ph√©p t·∫•t c·∫£ xem b·∫£ng ƒëi·ªÉm
        handler: async (request, response, context) => {
          const { record, currentAdmin } = context;
          return {
            record: record.toJSON ? record.toJSON(currentAdmin) : record
          };
        }
      },
      gradeHistory: {
        actionType: 'record',
        label: 'L·ªãch s·ª≠ s·ª≠a ƒëi·ªÉm',
        component: Components.StudentGradeHistoryTab,
        showInDrawer: false,
        isVisible: true,
        isAccessible: ({ currentAdmin }) => currentAdmin?.role === 'admin', // Ch·ªâ admin xem l·ªãch s·ª≠
        handler: async (request, response, context) => {
          const { record } = context;
          return {
            record: record.toJSON ? record.toJSON(context.currentAdmin) : record
          };
        }
      }
    }
  }
};

export default StudentResource;
